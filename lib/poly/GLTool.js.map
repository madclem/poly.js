{"version":3,"sources":["../../src/poly/GLTool.js"],"names":["_lastMesh","_lastProgram","aspectRatio","state","enabledVertexAttributes","instancedAttributes","gl","init","_hasInstance","checkExtension","_instanceExt","getExtension","mesh","program","i","_attributes","length","attrib","bindBuffer","ARRAY_BUFFER","buffer","attribLocation","getAttributeLocation","name","vertexAttribPointer","itemSize","FLOAT","instanceCount","instance","vertexAttribDivisorANGLE","push","indexOf","enableVertexAttribArray","indexBuffer","ELEMENT_ARRAY_BUFFER","camera","_camera","uniforms","projectionMatrix","viewMatrix","matrix","modelMatrix","_matrix","resetInstancedAttribute","_bindBuffers","update","setState","_updateMatrices","drawElementsInstancedANGLE","drawType","_indices","UNSIGNED_SHORT","drawArraysInstancedANGLE","_numItems","drawElements","drawArrays","w","h","POLY","canvas","width","height","viewportWidth","viewportHeight","viewport"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;;;;;kBAEe;AAEd,mBACA;AAAA;;AACC,OAAKA,SAAL,GAAiB,IAAjB;AACA,OAAKC,YAAL,GAAoB,IAApB;AACA,OAAKC,WAAL,GAAmB,CAAnB;AACA,OAAKC,KAAL,GAAa,IAAb;AACA,OAAKC,uBAAL,GAA+B,EAA/B;;AAEA,OAAKC,mBAAL,GAA2B,EAA3B;AACA;;AAXa;AAAA;AAAA,uBAaTC,EAbS,EAcd;AACC,QAAKH,KAAL,GAAa,oBAAUG,EAAV,CAAb;AACA,0BAAaC,IAAb;AACA,QAAKC,YAAL,GAAoB,uBAAaC,cAAb,CAA4B,wBAA5B,CAApB;AACA,QAAKC,YAAL,GAAoB,uBAAaC,YAAb,CAA0B,wBAA1B,CAApB;AACA;AAnBa;AAAA;AAAA,+BAqBDC,IArBC,EAsBd;AACC,OAAIN,KAAKM,KAAKC,OAAL,CAAaP,EAAtB;;AAEA,QAAI,IAAIQ,IAAI,CAAZ,EAAeA,IAAIF,KAAKG,WAAL,CAAiBC,MAApC,EAA4CF,GAA5C,EACA;AACC,QAAIG,SAASL,KAAKG,WAAL,CAAiBD,CAAjB,CAAb;AACAR,OAAGY,UAAH,CAAcZ,GAAGa,YAAjB,EAA+BF,OAAOG,MAAtC;AACA,QAAIC,iBAAiBT,KAAKC,OAAL,CAAaS,oBAAb,CAAkCL,OAAOM,IAAzC,CAArB;AACGjB,OAAGkB,mBAAH,CAAuBH,cAAvB,EAAuCJ,OAAOQ,QAA9C,EAAwDnB,GAAGoB,KAA3D,EAAkE,KAAlE,EAAyE,CAAzE,EAA4E,CAA5E;;AAEH,QAAGd,KAAKe,aAAL,GAAqB,CAArB,IAA0BV,OAAOW,QAAjC,IAA6C,KAAKpB,YAArD,EACA;AACC,UAAKE,YAAL,CAAkBmB,wBAAlB,CAA2CR,cAA3C,EAA2D,CAA3D;;AAEA,UAAKhB,mBAAL,CAAyByB,IAAzB,CAA8BT,cAA9B;AACA;;AAED,QAAG,KAAKjB,uBAAL,CAA6B2B,OAA7B,CAAqCV,cAArC,MAAyD,CAAC,CAA7D,EACS;AACI,UAAKjB,uBAAL,CAA6B0B,IAA7B,CAAkCT,cAAlC;AACZf,QAAG0B,uBAAH,CAA2BX,cAA3B,EAFQ,CAEoC;AAC5C;AACD;;AAED,OAAGT,KAAKqB,WAAR,EACA;AACC3B,OAAGY,UAAH,CAAcZ,GAAG4B,oBAAjB,EAAuCtB,KAAKqB,WAA5C;AACA;AACD;AAlDa;AAAA;AAAA,4BAoDJE,MApDI,EAqDd;AACC,QAAKC,OAAL,GAAeD,MAAf;AACA;AAvDa;AAAA;AAAA,kCAyDEvB,IAzDF,EA0Dd;AACC,OAAIC,UAAUD,KAAKC,OAAnB;AACAA,WAAQwB,QAAR,CAAiBC,gBAAjB,GAAoC,KAAKF,OAAL,CAAaE,gBAAjD;AACGzB,WAAQwB,QAAR,CAAiBE,UAAjB,GAA8B,KAAKH,OAAL,CAAaI,MAA3C;AACA3B,WAAQwB,QAAR,CAAiBI,WAAjB,GAA+B7B,KAAK8B,OAApC;AAEH;AAhEa;AAAA;AAAA,uBAkET9B,IAlES,EAmEd;;AAEC,OAAG,KAAKZ,SAAL,KAAmBY,IAAtB,EACA;AACC;AACA;AACA,SAAK+B,uBAAL;;AAEA,SAAKC,YAAL,CAAkBhC,IAAlB;AACA,SAAKZ,SAAL,GAAiBY,IAAjB;AACA;;AAED,OAAG,KAAKX,YAAL,KAAsBW,KAAKC,OAA9B,EACA;AACC,SAAKZ,YAAL,GAAoBW,KAAKC,OAAzB;AACA;;AAEDD,QAAKiC,MAAL;AACA,OAAIvC,KAAKM,KAAKC,OAAL,CAAaP,EAAtB;;AAEA,OAAGM,KAAKT,KAAR,EACA;AACC,SAAKA,KAAL,CAAW2C,QAAX,CAAoBlC,KAAKT,KAAzB;AAEA;;AAED,OAAG,KAAKiC,OAAR,EACA;AACC,SAAKW,eAAL,CAAqBnC,IAArB;AACA;;AAID,OAAGA,KAAKe,aAAL,GAAqB,CAArB,IAA0B,KAAKnB,YAAlC,EACA;AACC,QAAGI,KAAKqB,WAAR,EACA;AACC,UAAKvB,YAAL,CAAkBsC,0BAAlB,CAA6CpC,KAAKqC,QAAlD,EAA4DrC,KAAKsC,QAAL,CAAclC,MAA1E,EAAkFV,GAAG6C,cAArF,EAAqG,CAArG,EAAwGvC,KAAKe,aAA7G;AACA,KAHD,MAKA;AACC,UAAKjB,YAAL,CAAkB0C,wBAAlB,CAA2CxC,KAAKqC,QAAhD,EAA0D,CAA1D,EAA6DrC,KAAKyC,SAAlE,EAA6EzC,KAAKe,aAAlF;AACA;AACD,IAVD,MAWK,IAAGf,KAAKqB,WAAR,EACL;AACC3B,OAAGgD,YAAH,CAAgB1C,KAAKqC,QAArB,EAA+BrC,KAAKsC,QAAL,CAAclC,MAA7C,EAAqDV,GAAG6C,cAAxD,EAAwE,CAAxE;AACA,IAHI,MAKL;AACC7C,OAAGiD,UAAH,CAAc3C,KAAKqC,QAAnB,EAA6B,CAA7B,EAAgCrC,KAAKyC,SAArC;AACA;AAED;;AAED;AACA;;AA3Hc;AAAA;AAAA,4CA6Hd;AACC,OAAG,KAAKhD,mBAAL,CAAyBW,MAAzB,GAAkC,CAAlC,IAAuC,KAAKR,YAA/C,EACA;AACC,SAAK,IAAIM,IAAI,CAAb,EAAgBA,IAAI,KAAKT,mBAAL,CAAyBW,MAA7C,EAAqDF,GAArD,EAA0D;AACzD,SAAIO,iBAAiB,KAAKhB,mBAAL,CAAyBS,CAAzB,CAArB;AACA,UAAKJ,YAAL,CAAkBmB,wBAAlB,CAA2CR,cAA3C,EAA2D,CAA3D;AACA;;AAED,SAAKhB,mBAAL,GAA2B,EAA3B;AACA;AACD;AAvIa;AAAA;AAAA,yBAyIPmD,CAzIO,EAyIJC,CAzII,EA0Id;AACC,OAAInD,KAAKoD,KAAKpD,EAAd;AACAA,MAAGqD,MAAH,CAAUC,KAAV,GAAkBJ,CAAlB;AACAlD,MAAGqD,MAAH,CAAUE,MAAV,GAAmBJ,CAAnB;;AAEAnD,MAAGwD,aAAH,GAAmBN,CAAnB;AACMlD,MAAGyD,cAAH,GAAoBN,CAApB;AACNnD,MAAG0D,QAAH,CAAY,CAAZ,EAAe,CAAf,EAAkB1D,GAAGwD,aAArB,EAAoCxD,GAAGyD,cAAvC;;AAEA,QAAK7D,WAAL,GAAmBsD,IAAEC,CAArB;AACA;AApJa;;AAAA;AAAA,M","file":"GLTool.js","sourcesContent":["import State from './State';\r\nimport GLExtensions from './GLExtensions';\r\n\r\nexport default new class GLTool\r\n{\r\n\tconstructor()\r\n\t{\r\n\t\tthis._lastMesh = null;\r\n\t\tthis._lastProgram = null;\r\n\t\tthis.aspectRatio = 0;\r\n\t\tthis.state = null;\r\n\t\tthis.enabledVertexAttributes = [];\r\n\r\n\t\tthis.instancedAttributes = [];\r\n\t}\r\n\r\n\tinit(gl)\r\n\t{\r\n\t\tthis.state = new State(gl);\r\n\t\tGLExtensions.init();\r\n\t\tthis._hasInstance = GLExtensions.checkExtension('ANGLE_instanced_arrays');\r\n\t\tthis._instanceExt = GLExtensions.getExtension('ANGLE_instanced_arrays');\r\n\t}\r\n\r\n\t_bindBuffers(mesh)\r\n\t{\r\n\t\tlet gl = mesh.program.gl;\r\n\r\n\t\tfor(let i = 0; i < mesh._attributes.length; i++)\r\n\t\t{\r\n\t\t\tlet attrib = mesh._attributes[i];\r\n\t\t\tgl.bindBuffer(gl.ARRAY_BUFFER, attrib.buffer);\r\n\t\t\tlet attribLocation = mesh.program.getAttributeLocation(attrib.name);\r\n    \t\tgl.vertexAttribPointer(attribLocation, attrib.itemSize, gl.FLOAT, false, 0, 0);\r\n\r\n\t\t\tif(mesh.instanceCount > 0 && attrib.instance && this._hasInstance)\r\n\t\t\t{\r\n\t\t\t\tthis._instanceExt.vertexAttribDivisorANGLE(attribLocation, 1);\r\n\r\n\t\t\t\tthis.instancedAttributes.push(attribLocation);\r\n\t\t\t}\r\n\r\n\t\t\tif(this.enabledVertexAttributes.indexOf(attribLocation) === -1)\r\n            {\r\n                this.enabledVertexAttributes.push(attribLocation)\r\n\t\t\t\tgl.enableVertexAttribArray(attribLocation); // NEVER FORGET THAT LINE (I did...)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(mesh.indexBuffer)\r\n\t\t{\r\n\t\t\tgl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, mesh.indexBuffer);\r\n\t\t}\r\n\t}\r\n\r\n\tsetCamera(camera)\r\n\t{\r\n\t\tthis._camera = camera;\r\n\t}\r\n\r\n\t_updateMatrices(mesh)\r\n\t{\r\n\t\tlet program = mesh.program;\r\n\t\tprogram.uniforms.projectionMatrix = this._camera.projectionMatrix;\r\n\t    program.uniforms.viewMatrix = this._camera.matrix;\r\n\t    program.uniforms.modelMatrix = mesh._matrix;\r\n\r\n\t}\r\n\r\n\tdraw(mesh)\r\n\t{\r\n\r\n\t\tif(this._lastMesh !== mesh)\r\n\t\t{\r\n\t\t\t// /!\\ it's important to call it here because if there is only one instanced object on scene, it will be drawn only\r\n\t\t\t// once, although we don't want to reset the instanced attributes :)\r\n\t\t\tthis.resetInstancedAttribute();\r\n\r\n\t\t\tthis._bindBuffers(mesh);\r\n\t\t\tthis._lastMesh = mesh;\r\n\t\t}\r\n\r\n\t\tif(this._lastProgram !== mesh.program)\r\n\t\t{\r\n\t\t\tthis._lastProgram = mesh.program;\r\n\t\t}\r\n\r\n\t\tmesh.update();\r\n\t\tlet gl = mesh.program.gl;\r\n\r\n\t\tif(mesh.state)\r\n\t\t{\r\n\t\t\tthis.state.setState(mesh.state);\r\n\r\n\t\t}\r\n\r\n\t\tif(this._camera)\r\n\t\t{\r\n\t\t\tthis._updateMatrices(mesh);\r\n\t\t}\r\n\r\n\r\n\r\n\t\tif(mesh.instanceCount > 0 && this._hasInstance)\r\n\t\t{\r\n\t\t\tif(mesh.indexBuffer)\r\n\t\t\t{\r\n\t\t\t\tthis._instanceExt.drawElementsInstancedANGLE(mesh.drawType, mesh._indices.length, gl.UNSIGNED_SHORT, 0, mesh.instanceCount);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis._instanceExt.drawArraysInstancedANGLE(mesh.drawType, 0, mesh._numItems, mesh.instanceCount);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(mesh.indexBuffer)\r\n\t\t{\r\n\t\t\tgl.drawElements(mesh.drawType, mesh._indices.length, gl.UNSIGNED_SHORT, 0);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tgl.drawArrays(mesh.drawType, 0, mesh._numItems);\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// very important to reset the attributes location from one object to another as some of them\r\n\t// could be not instanced, etc. but share the same attrib location\r\n\tresetInstancedAttribute()\r\n\t{\r\n\t\tif(this.instancedAttributes.length > 0 && this._hasInstance)\r\n\t\t{\r\n\t\t\tfor (var i = 0; i < this.instancedAttributes.length; i++) {\r\n\t\t\t\tlet attribLocation = this.instancedAttributes[i]\r\n\t\t\t\tthis._instanceExt.vertexAttribDivisorANGLE(attribLocation, 0);\r\n\t\t\t}\r\n\r\n\t\t\tthis.instancedAttributes = [];\r\n\t\t}\r\n\t}\r\n\r\n\tresize(w, h)\r\n\t{\r\n\t\tlet gl = POLY.gl;\r\n\t\tgl.canvas.width = w;\r\n\t\tgl.canvas.height = h;\r\n\r\n\t\tgl.viewportWidth = w;\r\n        gl.viewportHeight = h;\r\n\t\tgl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);\r\n\r\n\t\tthis.aspectRatio = w/h;\r\n\t}\r\n}\r\n"]}
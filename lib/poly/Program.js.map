{"version":3,"sources":["../../src/poly/Program.js"],"names":["Program","vertShader","fragShader","uniforms","gl","POLY","console","log","cacheAttributesLocation","cacheUniformsLocation","program","createProgram","vert","_createShader","frag","_attachShaders","linkProgram","getProgramParameter","LINK_STATUS","useProgram","_createGetterSetterUniforms","uniform","addUniformLocation","name","getUniformLocation","undefined","_this","Proxy","get","target","value","set","CONST","uniformTypes","type","getAttribLocation","enableVertexAttribArray","addAttributeLocation","getAttributeLocation","attachShader","src","isVertex","shader","createShader","VERTEX_SHADER","FRAGMENT_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog"],"mappings":"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","file":"Program.js","sourcesContent":["export default class Program\r\n{\r\n    constructor(vertShader, fragShader, uniforms)\r\n    {\r\n        let gl = POLY.gl; // not sure that's great... :p\r\n        this.gl = gl;\r\n        console.log(uniforms)\r\n        // cache the locations of attributes and uniforms\r\n        this.cacheAttributesLocation = {}\r\n        this.cacheUniformsLocation = {}\r\n\r\n        // create the program itself\r\n        this.program = gl.createProgram();\r\n\r\n        let vert = this._createShader(vertShader, true);\r\n        let frag = this._createShader(fragShader, false);\r\n        this._attachShaders(vert, frag);\r\n\r\n        gl.linkProgram(this.program);\r\n\r\n        // check for errors\r\n        if (!gl.getProgramParameter(this.program, gl.LINK_STATUS))\r\n        {\r\n            throw \"Couldn't initialise program\";\r\n        }\r\n\r\n        gl.useProgram(this.program);\r\n\r\n        this._createGetterSetterUniforms(uniforms);\r\n        for (let uniform in uniforms)\r\n        {\r\n            this.addUniformLocation(uniform);\r\n            console.log(uniform, uniforms, this.uniforms)\r\n            // uniform = this.uniforms[uniform];\r\n            // this.uniforms[uniform] = uniforms[uniform]\r\n            this.uniforms[uniform] = uniforms[uniform];\r\n\r\n        }\r\n\r\n    }\r\n\r\n    addUniformLocation(name)\r\n    {\r\n        this.cacheUniformsLocation[name] = this.gl.getUniformLocation(this.program, name);\r\n    }\r\n\r\n    getUniformLocation(name)\r\n    {\r\n        if(this.cacheUniformsLocation[name] !== undefined)\r\n        {\r\n            return this.cacheUniformsLocation[name];\r\n        }\r\n        else\r\n        {\r\n            this.addUniformLocation(name);\r\n            \r\n            return this.getUniformLocation(name);\r\n        }\r\n    }\r\n\r\n\r\n    // create a this.uniforms property\r\n    // useful for the setter, we can just update the uniform when it gets changed\r\n    _createGetterSetterUniforms(uniforms)\r\n    {   \r\n        let gl = this.gl;\r\n        let program = this.program;\r\n        let _this = this;\r\n\r\n        this.uniforms = new Proxy(uniforms, {\r\n            get: function(target, name) \r\n            {\r\n                if (!(name in target)) \r\n                {\r\n                    console.log(\"Getting non-existant property '\" + name + \"'\");\r\n                    return undefined;\r\n                }\r\n\r\n                return target[name].value;\r\n            },\r\n            set: function(target, name, value) \r\n            {\r\n                if (!(name in target)) \r\n                {\r\n                    console.log(\"Setting non-existant property '\" + name + \"', initial value: \" + value);\r\n\r\n                    return false;\r\n                }\r\n\r\n                console.log('here', target, name, value)\r\n                // /!\\ TODO check GLShader.uniform() when it's not a number, seems more optimised\r\n                target[name] = value.value;\r\n                gl[POLY.CONST.uniformTypes[target[name].type]](_this.getUniformLocation(name), false, value.value);\r\n               \r\n                return true;\r\n            }\r\n        });\r\n    }\r\n\r\n    addAttributeLocation(name)\r\n    {\r\n        this.cacheAttributesLocation[name] = this.gl.getAttribLocation(this.program, name);\r\n        this.gl.enableVertexAttribArray(this.cacheAttributesLocation[name]); // NEVER FORGET THAT LINE (I did...)\r\n    }\r\n\r\n    getAttributeLocation(name)\r\n    {\r\n        if(this.cacheAttributesLocation[name] !== undefined)\r\n        {\r\n            return this.cacheAttributesLocation[name];\r\n        }\r\n        else\r\n        {\r\n            this.addAttributeLocation(name);\r\n\r\n            return this.getAttributeLocation(name);\r\n        }\r\n    }\r\n\r\n    _attachShaders(vert, frag)\r\n    {\r\n        this.gl.attachShader(this.program, vert);\r\n        this.gl.attachShader(this.program, frag);\r\n    }\r\n\r\n    _createShader(src, isVertex)\r\n    {\r\n        let gl = this.gl;\r\n        let shader;\r\n        if (isVertex)\r\n        {\r\n            shader = gl.createShader(gl.VERTEX_SHADER);\r\n        }\r\n        else\r\n        {\r\n            shader = gl.createShader(gl.FRAGMENT_SHADER);\r\n        }\r\n\r\n        this.gl.shaderSource(shader, src);\r\n        this.gl.compileShader(shader);\r\n\r\n        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS))\r\n        {\r\n            throw (\"Couldn't initialise shader, \", gl.getShaderInfoLog(shader));\r\n            return null;\r\n        }\r\n\r\n        return shader;\r\n    }\r\n}\r\n"]}